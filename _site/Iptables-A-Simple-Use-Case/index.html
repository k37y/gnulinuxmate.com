<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Iptables - A simple use case &#8211; linuxmate</title> <meta name="description" content="IntroductionIptables is a user-space utility program that allows a system administrator to configure the tables provided by the Linux kernel firewall (implemented as different Netfilter modules) and the chains and rules it stores."> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="http://localhost:4000//images/iptables.jpg"> <meta name="twitter:title" content="Iptables - A simple use case"> <meta name="twitter:description" content="IntroductionIptables is a user-space utility program that allows a system administrator to configure the tables provided by the Linux kernel firewall (implemented as different Netfilter modules) and the chains and rules it stores."> <meta name="twitter:site" content="@kevy_vinu"> <meta name="twitter:creator" content="@kevy_vinu"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Iptables - A simple use case"> <meta property="og:description" content="IntroductionIptables is a user-space utility program that allows a system administrator to configure the tables provided by the Linux kernel firewall (implemented as different Netfilter modules) and the chains and rules it stores."> <meta property="og:url" content="http://localhost:4000/Iptables-A-Simple-Use-Case/"> <meta property="og:site_name" content="linuxmate"> <meta property="og:image" content="http://localhost:4000/images/halve.png"> <link rel="canonical" href="http://localhost:4000/Iptables-A-Simple-Use-Case/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000//images/iptables.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/posts.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Iptables - A simple use case </h1> <ul class="tags"> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/Iptables-A-Simple-Use-Case/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/Iptables-A-Simple-Use-Case/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a href="/portfolio" title="portfolio" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">02 Jan 2018</div> <h3 id="introduction">Introduction</h3> <p>Iptables is a user-space utility program that allows a system administrator to configure the tables provided by the Linux kernel firewall (implemented as different Netfilter modules) and the chains and rules it stores.</p> <blockquote> <p>“Iptables is a command line utility for configuring Linux kernel firewall implemented within the Netfilter project. The term iptables is also commonly used to refer to this kernel-level firewall. It can be configured directly with iptables, or by using one of the many frontends and GUIs. iptables is used for IPv4 and ip6tables is used for IPv6.” says <a href="https://wiki.archlinux.org/index.php/iptables">ArchWiki</a></p> </blockquote> <h3 id="installation">Installation</h3> <p>Redhat based distribution</p> <div class="highlighter-rouge"><pre class="highlight"><code>yum install iptables
</code></pre></div> <p>Debian-based distribution</p> <div class="highlighter-rouge"><pre class="highlight"><code>apt-get install iptables
</code></pre></div> <p>After the successful installation, make sure the service is up and running. I use Ubuntu 16.04 LTS for explaning iptables here as Linux box. Clear all pre-loaded rule in iptables by the command <code class="highlighter-rouge">iptables -F</code> <code class="highlighter-rouge">iptables -F -t nat</code>. Enable iptables in start-up using <code class="highlighter-rouge">systemctl enable iptables</code>.</p> <h3 id="use-case">Use case</h3> <p>I have been using iptables on a regular basis in my Linux-box specially assigned for network routing jobs which is Ubuntu 16.04 LTS server edition. NAT (Network Address Translation) is the iptables’s feature which I am more impressed with.</p> <blockquote> <p>“Network address translation (NAT) is a method of remapping one IP address space into another by modifying network address information in IP header of packets while they are in transit across a traffic routing device.” says Wikipedia.</p> </blockquote> <p>Any Linux-box is having two NIC (Network Interface Card) can be turn into a router with following command:</p> <div class="highlighter-rouge"><pre class="highlight"><code> echo 1 &gt; /proc/sys/net/ipv4/ipv4_forward
</code></pre></div> <p>For persistent changes, open <code class="highlighter-rouge">/etc/sysctl.conf</code> and uncomment <code class="highlighter-rouge">net.ipv4.ip_forward=1</code></p> <p>Now the second NIC can talk to internet without flaws. NAT is mainly divided into DNAT (Destination NAT) and SNAT (Source NAT). In simple, SNAT and MASQUERADE are for outside traffic routing while DNAT for inside one. Let us take one example here.</p> <div class="highlighter-rouge"><pre class="highlight"><code>                  eth0      ____      eth1                       .-,(  ),-.
  ____   __    192.168.1.1 |====| 125.99.121.62               .-(          )-.
 |    | |==|--------------&gt;|    |---------&gt;               --&gt;(    internet    )
 |____| |  |               |    |          |              ^   '-(          ).-'
 /::::/ |__|               |____|          |    ______    |       '-.( ).-'
                                           '--&gt;|_ooo_°|---'
 Workstation               Router
   Fedora          Ubuntu 16.04 LTS Server     ISP Modem
</code></pre></div> <p>As the above diagram shows, Fedora 27 is my PC and Ubuntu 16.04 LTS Server is a headless server which acts as a router here. For inside network we have <code class="highlighter-rouge">eth0</code> network interface while <code class="highlighter-rouge">eth1</code> connects to the internet. I have removed <code class="highlighter-rouge">ufw</code> which is iptables front-end application comes default with Ubuntu distribution. To make some fresh rules we need to flush iptables rules first:</p> <div class="highlighter-rouge"><pre class="highlight"><code> sudo iptables -F
 sudo iptables -F -t nat
</code></pre></div> <p>We have internal IP of 192.168.1.1 which will act as router IP and pre-configured as DHCP server. Assuming Workstation(enp2s1) has assigned the IP of 192.168.1.2 as the Workstation configured in <code class="highlighter-rouge">/etc/network/interfaces</code> to ask IP from DHCP server in Ubuntu machine:</p> <div class="highlighter-rouge"><pre class="highlight"><code> auto enp2s1
 iface enp2s1 inet dhcp
</code></pre></div> <p>Ubuntu machine will now act as a gateway for Fedora machine and every query hits to the NIC <code class="highlighter-rouge">eth0</code>. Our next step is to configure <code class="highlighter-rouge">iptables</code> to MASQUERADE the traffic coming to <code class="highlighter-rouge">eth0</code> so that the internal host such as <code class="highlighter-rouge">192.168.1.2</code> can talk to internet. As I mentioned above, this is inside to outside traffic using the Ubuntu gateway so we use MASQUERADE or SNAT rules in POSTROUTING chain.</p> <div class="highlighter-rouge"><pre class="highlight"><code> sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
</code></pre></div> <p>Now we are able to ping to 8.8.8.8 from Fedora machine as we are connected to internet. SNAT particularly useful for changing the source IP when it comes to internal to external traffic.</p> <p>Let us take DNAT into account. Consider we require a ssh connection to Fedora machine from outside world or internet (Assuming our ISP allows this, they do not usually though). This time rule is adding to PREROUTING chain:</p> <div class="highlighter-rouge"><pre class="highlight"><code> sudo iptables -t nat -A PREROUTING -j DNAT -p tcp --dport 22 --destination 125.99.121.62 --to-destination 192.168.1.2
</code></pre></div> <p><code class="highlighter-rouge">dport</code>: port of Ubuntu machine<br /> <code class="highlighter-rouge">destination</code>: IP of Ubuntu machine<br /> <code class="highlighter-rouge">to-destination</code>: IP of Fedora machine</p> <h3 id="conclusion">Conclusion</h3> <p>We have gone through very little possibilities of iptables here. This knowledge is more enough to turn your unused PC or inexpensive dedicated PC such as Raspberry Pi into a full functioning home router. I have been using DIY home router for the past some years. If you could find any doubts, do not hesitate to ask me in the comment box below.</p> <br> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/Iptables-A-Simple-Use-Case/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/Iptables-A-Simple-Use-Case/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <nav class="pagination"> <a href="http://localhost:4000/Docker-A-brief-Introduction/" class="pagination_pager" title="Docker - A brief introduction ">previous</a> <a href="http://localhost:4000/How-To-Configure-Chroot-SFTP-Server-In-Linux/" class="pagination_pager" title="How to configure chroot SFTP server in Linux ">next</a> </nav> <br> <br> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'linuxmate-ml'; /* ensure that pages with query string get the same discussion */ var url_parts = window.location.href.split("?"); var disqus_url = url_parts[0]; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> </body> </html>
